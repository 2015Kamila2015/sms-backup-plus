<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>
      SMS Backup+ error report
    </title>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript">
      google.load('visualization', '1', {packages: ['corechart', 'table']});
    </script>
    <script type="text/javascript">
      function show(spreadsheet, analysis) {
        var q = new google.visualization.Query(spreadsheet);
        q.setQuery(analysis['query']);

        q.send(function(response) {
          var spinner = document.getElementById('spinner');
          spinner.style.display = "none";

          if (response.isError()) {
            var errors  = document.getElementById('errors');
            errors.innerHTML = 'Error in query: ' + response.getMessage() +
                               ' ' + response.getDetailedMessage();
          } else {
            var data = response.getDataTable();

            var container = document.createElement('div');
            document.getElementById('reports').appendChild(container);

            var table = new google.visualization.Table(container);
            table.draw(data, {title: analysis['title']});

            var view = new google.visualization.DataView(data);
            var columns = view.getViewColumns();

            // produce one piechart per pivot point
            for (var i=1; i<columns.length; i++) {
              view.setColumns([0, columns[i]]);

              var version = view.getColumnLabel(1);
              if (version && !(version === "")) {
                var container = document.createElement('div');
                document.getElementById('reports').appendChild(container);

                var piechart = new google.visualization.PieChart(container);
                piechart.draw(view, {legend: 'bottom',
                                     pieSliceText: 'label',
                                     height: 500,
                                     title: analysis['title'] + ': ' + version});
              }
            }
          }
        });
      }

      google.setOnLoadCallback(function() {
        var sheet = document.getElementById('spreadsheet');
        if (sheet) {
          // N = model, B = version, F = android_version
          var queries = [
            {
              query: 'SELECT N, COUNT(A) GROUP BY N PIVOT B',
              title: 'Crash by model',
            },
            {
              query: 'SELECT F, COUNT(A) GROUP BY F PIVOT B',
              title: 'Crash by version'
            }
          ];

          for (var i=0; i<queries.length;i++) {
            show(sheet.href, queries[i]);
          }
        }
      });
    </script>
  </head>

  <body style="font-family: Arial;border: 0 none;">
    <h1>SMS Backup+ error reports</h1>
    <a id="spreadsheet"
       href="https://spreadsheets.google.com/ccc?key=0At-v8_qu4q4VdFZOM3JNWng5bmZYLXNCWFJ0b1hPdHc&authkey=CMKWmssL">
      Spreadsheet
    </a>

    <div id="spinner">
      Loading...
    </div>

    <div id="errors">
    </div>

    <div id="reports">
    </div>
  </body>
</html>
